<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">


        <!-- Latest compiled and minified JavaScript -->
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="js/libs/jsTree/themes/default/style.min.css" />
        <script src="js/libs/jsTree/jstree.js"></script>
        <link rel="stylesheet" href="css/default.css">

        <script src="js/libs/downloadify/downloadify.min.js"></script>
        <script src="js/libs/downloadify/swfobject.js"></script>

        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>
    <body>
        <script>
            var fileName;
            var fileData;
            var file;
        </script>
        <div class="container">
	<div class="row clearfix">
		<div class="col-md-12 column">
			<div id="loadJumbo" class="jumbotron well">
				<h1>
					Welcome
				</h1>
				<p>
					Here you can load your directory structure and chose which files you need. Let's start loading the file.
				</p>
				<p>
                                    <a id="load" onclick="$('input').click()" class="btn btn-success btn-small">
                                        <i class="glyphicon-white glyphicon glyphicon-folder-open" style="margin-right: 10px;"></i>load
                                    </a>
				</p>
			</div>
			<div id="treeJumbo" class="jumbotron" disabled>
				<h1>
					File selection
				</h1>
				<p>
                                    Now chose the files you need, then click <em>download</em> when you're finished.
				</p>
                                <i class="glyphicon glyphicon-search margin-little" ></i><input type="text" id="search" value="" class="input">
                                    <div id="tree"></div>
                                
			</div>
                    
		</div>
	</div>
</div>
        <a id="download" class="margin-little btn btn-danger btn-large bottom" download><i class="glyphicon-white glyphicon-download-alt" style="margin-right: 10px;"></i>download</a>

        
        <input id="fileInput" type="file"/>
        
        
        <div id="downloadify"></div>

        <script>
            var getTreeData=function(){
                return $.jstree.reference('#tree').get_json('#', { 'flat': false });
            }
            function SaveToDisk(fileURL, fileName) {
                // for non-IE
                if (!window.ActiveXObject) {
                    var save = document.createElement('a');
                    save.href = fileURL;
                    save.target = '_blank';
                    save.download = fileName || 'unknown';

                    var event = document.createEvent('Event');
                    event.initEvent('click', true, true);
                    save.dispatchEvent(event);
                    (window.URL || window.webkitURL).revokeObjectURL(save.href);
                }

                // for IE
                else if ( !! window.ActiveXObject && document.execCommand)     {
                    var _window = window.open(fileURL, '_blank');
                    _window.document.close();
                    _window.document.execCommand('SaveAs', true, fileName || fileURL)
                    _window.close();
                }
            }
            function SaveBlobToDisk(blobURL, fileName) {
                var reader = new FileReader();
                reader.readAsDataURL(blobURL);
                reader.onload = function (event) {
                    var save = document.createElement('a');
                    save.href = event.target.result;
                    save.target = '_blank';
                    save.download = fileName || 'unknown file';

                    var event = document.createEvent('Event');
                    event.initEvent('click', true, true);
                    save.dispatchEvent(event);
                    (window.URL || window.webkitURL).revokeObjectURL(save.href);
                };
            }
            $("#treeJumbo").hide();
            $("#download").hide();
                var input = $("#fileInput");
                input.change(
                        function(eventData) {
                        file = input[0].files[0];
                        fileName = file.name;
                            var reader = new FileReader();
                            reader.onload = function(file) {
                                $("#loadJumbo").hide("slow",function(){
                                    $("#treeJumbo").show("slow",function(){
                                        $("#download").show("slow");
                                    });
                                });
                                
                                fileData = reader.result;
                                $('#tree').jstree({
                                    'core': {
                                        'data': [
                                            JSON.parse(fileData)
                                        ],
                                    },
                                    "plugins": ["checkbox", "search","sort","wholerow","types"],
                                    "checkbox": {
                                        "keep_selected_style": false
                                    },
                                    "search":{
                                        "show_only_matches":true
                                    },
                                    types:{
                                        file:{
                                            icon:"img/file.png"
                                        },
                                        directory:{
                                            icon:"img/folder.png"
                                        }
                                    }
                                });
                                var to = false;
                                $('#search').keyup(function() {
                                    if (to) {
                                        clearTimeout(to);
                                    }
                                    to = setTimeout(function() {
                                        var v = $('#search').val();
                                        $('#tree').jstree(true).search(v);
                                    }, 250);
                                });
                                //$("#save").attr("href",window.URL.createObjectURL(new Blob([fileData], { type: 'text/plain' })));
                                //$("#download").attr("href", "data:application/octet-stream;charset=utf-8;base64," + window.btoa(fileData));

                                var json = JSON.stringify(fileData);
                                var blob = new Blob([json], {type: "application/json"});
                                var url = URL.createObjectURL(blob);

                                var a = $("#download");
//                                a.download = input.val().split("\\").pop();
//                                a.href = url;
                                a.click(function(){
                                    var json =JSON.stringify(getTreeData());
                                    var blob = new Blob([json], {type: "application/json"});
                                    SaveBlobToDisk(blob,fileName);
                                    //window.location= URL.createObjectURL(blob);
                                })
                                $("#downloadify").downloadify({
                                    filename: function() {
                                        return "save";
                                    },
                                    data: getTreeData,
                                    onComplete: function() {
                                        alert('Your File Has Been Saved!');
                                    },
                                    onCancel: function() {
                                        alert('You have cancelled the saving of this file.');
                                    },
                                    onError: function() {
                                        alert('You must put something in the File Contents or there will be nothing to save!');
                                    },
                                    transparent: false,
                                    swf: 'js/libs/downloadify/downloadify.swf',
                                    downloadImage: 'img/transparent.png',
                                    width: $("#save_container").outerWidth(),
                                    height: $("#save_container").outerHeight(),
                                    append: false,
                                    transparent:true,
                                });
                            };

                            reader.readAsText(file);
                        });
        </script>
    </body>
</html>
